(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const V=Symbol("Comlink.proxy"),J=Symbol("Comlink.endpoint"),Q=Symbol("Comlink.releaseProxy"),N=Symbol("Comlink.finalizer"),P=Symbol("Comlink.thrown"),U=t=>typeof t=="object"&&t!==null||typeof t=="function",Z={canHandle:t=>U(t)&&t[V],serialize(t){const{port1:e,port2:n}=new MessageChannel;return I(t,e),[n,[n]]},deserialize(t){return t.start(),rt(t)}},tt={canHandle:t=>U(t)&&P in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},W=new Map([["proxy",Z],["throw",tt]]);function et(t,e){for(const n of t)if(e===n||n==="*"||n instanceof RegExp&&n.test(e))return!0;return!1}function I(t,e=globalThis,n=["*"]){e.addEventListener("message",function r(s){if(!s||!s.data)return;if(!et(n,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:a,type:c,path:l}=Object.assign({path:[]},s.data),u=(s.data.argumentList||[]).map(x);let o;try{const i=l.slice(0,-1).reduce((d,y)=>d[y],t),f=l.reduce((d,y)=>d[y],t);switch(c){case"GET":o=f;break;case"SET":i[l.slice(-1)[0]]=x(s.data.value),o=!0;break;case"APPLY":o=f.apply(i,u);break;case"CONSTRUCT":{const d=new f(...u);o=it(d)}break;case"ENDPOINT":{const{port1:d,port2:y}=new MessageChannel;I(t,y),o=dt(d,[d])}break;case"RELEASE":o=void 0;break;default:return}}catch(i){o={value:i,[P]:0}}Promise.resolve(o).catch(i=>({value:i,[P]:0})).then(i=>{const[f,d]=O(i);e.postMessage(Object.assign(Object.assign({},f),{id:a}),d),c==="RELEASE"&&(e.removeEventListener("message",r),G(e),N in t&&typeof t[N]=="function"&&t[N]())}).catch(i=>{const[f,d]=O({value:new TypeError("Unserializable return value"),[P]:0});e.postMessage(Object.assign(Object.assign({},f),{id:a}),d)})}),e.start&&e.start()}function nt(t){return t.constructor.name==="MessagePort"}function G(t){nt(t)&&t.close()}function rt(t,e){const n=new Map;return t.addEventListener("message",function(s){const{data:a}=s;if(!a||!a.id)return;const c=n.get(a.id);if(c)try{c(a)}finally{n.delete(a.id)}}),z(t,n,[],e)}function T(t){if(t)throw new Error("Proxy has been released and is not useable")}function q(t){return g(t,new Map,{type:"RELEASE"}).then(()=>{G(t)})}const A=new WeakMap,R="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(A.get(t)||0)-1;A.set(t,e),e===0&&q(t)});function st(t,e){const n=(A.get(e)||0)+1;A.set(e,n),R&&R.register(t,e,t)}function at(t){R&&R.unregister(t)}function z(t,e,n=[],r=function(){}){let s=!1;const a=new Proxy(r,{get(c,l){if(T(s),l===Q)return()=>{at(a),q(t),e.clear(),s=!0};if(l==="then"){if(n.length===0)return{then:()=>a};const u=g(t,e,{type:"GET",path:n.map(o=>o.toString())}).then(x);return u.then.bind(u)}return z(t,e,[...n,l])},set(c,l,u){T(s);const[o,i]=O(u);return g(t,e,{type:"SET",path:[...n,l].map(f=>f.toString()),value:o},i).then(x)},apply(c,l,u){T(s);const o=n[n.length-1];if(o===J)return g(t,e,{type:"ENDPOINT"}).then(x);if(o==="bind")return z(t,e,n.slice(0,-1));const[i,f]=B(u);return g(t,e,{type:"APPLY",path:n.map(d=>d.toString()),argumentList:i},f).then(x)},construct(c,l){T(s);const[u,o]=B(l);return g(t,e,{type:"CONSTRUCT",path:n.map(i=>i.toString()),argumentList:u},o).then(x)}});return st(a,t),a}function ot(t){return Array.prototype.concat.apply([],t)}function B(t){const e=t.map(O);return[e.map(n=>n[0]),ot(e.map(n=>n[1]))]}const v=new WeakMap;function dt(t,e){return v.set(t,e),t}function it(t){return Object.assign(t,{[V]:!0})}function O(t){for(const[e,n]of W)if(n.canHandle(t)){const[r,s]=n.serialize(t);return[{type:"HANDLER",name:e,value:r},s]}return[{type:"RAW",value:t},v.get(t)||[]]}function x(t){switch(t.type){case"HANDLER":return W.get(t.name).deserialize(t.value);case"RAW":return t.value}}function g(t,e,n,r){return new Promise(s=>{const a=ct();e.set(a,s),t.start&&t.start(),t.postMessage(Object.assign({id:a},n),r)})}function ct(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const K={"floyd-steinberg":{denom:16,offsets:[{dx:1,dy:0,w:7},{dx:-1,dy:1,w:3},{dx:0,dy:1,w:5},{dx:1,dy:1,w:1}]},jjn:{denom:48,offsets:[{dx:1,dy:0,w:7},{dx:2,dy:0,w:5},{dx:-2,dy:1,w:3},{dx:-1,dy:1,w:5},{dx:0,dy:1,w:7},{dx:1,dy:1,w:5},{dx:2,dy:1,w:3},{dx:-2,dy:2,w:1},{dx:-1,dy:2,w:3},{dx:0,dy:2,w:5},{dx:1,dy:2,w:3},{dx:2,dy:2,w:1}]},stucki:{denom:42,offsets:[{dx:1,dy:0,w:8},{dx:2,dy:0,w:4},{dx:-2,dy:1,w:2},{dx:-1,dy:1,w:4},{dx:0,dy:1,w:8},{dx:1,dy:1,w:4},{dx:2,dy:1,w:2},{dx:-2,dy:2,w:1},{dx:-1,dy:2,w:2},{dx:0,dy:2,w:4},{dx:1,dy:2,w:2},{dx:2,dy:2,w:1}]},atkinson:{denom:8,offsets:[{dx:1,dy:0,w:1},{dx:2,dy:0,w:1},{dx:-1,dy:1,w:1},{dx:0,dy:1,w:1},{dx:1,dy:1,w:1},{dx:0,dy:2,w:1}]},burkes:{denom:32,offsets:[{dx:1,dy:0,w:8},{dx:2,dy:0,w:4},{dx:-2,dy:1,w:2},{dx:-1,dy:1,w:4},{dx:0,dy:1,w:8},{dx:1,dy:1,w:4},{dx:2,dy:1,w:2}]},"sierra-lite":{denom:4,offsets:[{dx:1,dy:0,w:2},{dx:-1,dy:1,w:1},{dx:0,dy:1,w:1}]},"sierra-2-4a":{denom:16,offsets:[{dx:1,dy:0,w:4},{dx:2,dy:0,w:3},{dx:-2,dy:1,w:1},{dx:-1,dy:1,w:2},{dx:0,dy:1,w:3},{dx:1,dy:1,w:2},{dx:2,dy:1,w:1}]},"sierra-3":{denom:32,offsets:[{dx:1,dy:0,w:5},{dx:2,dy:0,w:3},{dx:-2,dy:1,w:2},{dx:-1,dy:1,w:4},{dx:0,dy:1,w:5},{dx:1,dy:1,w:4},{dx:2,dy:1,w:2},{dx:-2,dy:2,w:2},{dx:-1,dy:2,w:3},{dx:0,dy:2,w:2}]},"stevenson-arce":{denom:200,offsets:[{dx:2,dy:0,w:32},{dx:-3,dy:1,w:12},{dx:-1,dy:1,w:26},{dx:1,dy:1,w:30},{dx:3,dy:1,w:16},{dx:-2,dy:2,w:12},{dx:0,dy:2,w:26},{dx:2,dy:2,w:12},{dx:-3,dy:3,w:5},{dx:-1,dy:3,w:12},{dx:1,dy:3,w:12},{dx:3,dy:3,w:5}]}};function _(t){const e=t/255;return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function lt(t){const e=t.replace("#","").trim(),n=e.length===3?e.split("").map(c=>c+c).join(""):e,r=parseInt(n.slice(0,2),16),s=parseInt(n.slice(2,4),16),a=parseInt(n.slice(4,6),16);return[r,s,a]}function ft(t,e,n){return[_(t),_(e),_(n)]}function Y(t,e,n){const[r,s,a]=ft(t,e,n),c=.4122214708*r+.5363325363*s+.0514459929*a,l=.2119034982*r+.6806995451*s+.1073969566*a,u=.0883024619*r+.2817188376*s+.6299787005*a,o=Math.cbrt(c),i=Math.cbrt(l),f=Math.cbrt(u),d=.2104542553*o+.793617785*i-.0040720468*f,y=1.9779984951*o-2.428592205*i+.4505937099*f,k=.0259040371*o+.7827717662*i-.808675766*f;return[d,y,k]}function ut(t,e){const n=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return Math.hypot(n,r,s)}function yt(t,e,n,r){if(r.length===0)return[t,e,n];const s=Y(t,e,n);let a=1/0,c=[t,e,n];for(let l=0;l<r.length;l++){const[u,o,i]=lt(r[l]||"#000000"),f=ut(s,Y(u,o,i));f<a&&(a=f,c=[u,o,i])}return c}function h(t){return t<0?0:t>255?255:t}function wt(t,e,n,r){t*=r.exposure,e*=r.exposure,n*=r.exposure,t=(t-128)*r.contrast+128,e=(e-128)*r.contrast+128,n=(n-128)*r.contrast+128;const s=.2126*t+.7152*e+.0722*n;t=s+(t-s)*r.saturation,e=s+(e-s)*r.saturation,n=s+(n-s)*r.saturation;const a=Math.max(.001,r.gamma);return t=Math.pow(Math.max(0,t/255),a)*255,e=Math.pow(Math.max(0,e/255),a)*255,n=Math.pow(Math.max(0,n/255),a)*255,[h(t),h(e),h(n)]}function xt(t,e,n){const{width:r,height:s,data:a}=t,c=new Uint8ClampedArray(r*s*4),l=new Float32Array(r*s),u=new Float32Array(r*s),o=new Float32Array(r*s);for(let d=0;d<s;d++)for(let y=0;y<r;y++){const k=n.pixelate>1?Math.floor(y/n.pixelate)*n.pixelate:y,S=((n.pixelate>1?Math.floor(d/n.pixelate)*n.pixelate:d)*r+k)*4,m=a[S],w=a[S+1],b=a[S+2],[E,M,C]=wt(m,w,b,n.grade),p=d*r+y;l[p]=E,u[p]=M,o[p]=C}const i=K[n.kernelName]||K["floyd-steinberg"],f=n.thresholdBias*32;for(let d=0;d<s;d++){const y=!n.serpentine||d%2===0,k=y?0:r-1,X=y?r:-1,S=y?1:-1;for(let m=k;m!=X;m+=S){const w=d*r+m;let b=l[w]+f,E=u[w]+f,M=o[w]+f;b=h(b),E=h(E),M=h(M);const[C,p,$]=yt(b,E,M,e);c[w*4+0]=C,c[w*4+1]=p,c[w*4+2]=$,c[w*4+3]=255;const gt=(b-C)*n.diffusionStrength,ht=(E-p)*n.diffusionStrength,mt=(M-$)*n.diffusionStrength;for(const L of i.offsets){const bt=y?L.dx:-L.dx,j=m+bt,D=d+L.dy;if(j<0||j>=r||D<0||D>=s)continue;const F=D*r+j,H=L.w/i.denom;l[F]+=gt*H,u[F]+=ht*H,o[F]+=mt*H}}}return new ImageData(c,r,s)}I({runED(t){const e=new ImageData(t.data,t.width,t.height),n=xt(e,t.palette,{serpentine:t.serpentine,diffusionStrength:t.diffusionStrength,thresholdBias:t.thresholdBias,pixelate:t.pixelate,kernelName:t.kernelName,grade:t.grade});return{width:n.width,height:n.height,data:n.data}}})})();
