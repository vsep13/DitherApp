(function(){"use strict";function f(t){return t<0?0:t>255?255:t}function K(t,d,e,s){t*=s.grade.exposure,d*=s.grade.exposure,e*=s.grade.exposure;const a=s.grade.contrast;t=(t-128)*a+128,d=(d-128)*a+128,e=(e-128)*a+128;const o=.2126*t+.7152*d+.0722*e,c=s.grade.saturation;t=o+(t-o)*c,d=o+(d-o)*c,e=o+(e-o)*c;const y=Math.max(.001,s.grade.gamma);return t=Math.pow(Math.max(0,t/255),y)*255,d=Math.pow(Math.max(0,d/255),y)*255,e=Math.pow(Math.max(0,e/255),y)*255,[f(t),f(d),f(e)]}function N(t,d,e,s){let a=1/0,o=t,c=d,y=e;const q=s.length/3|0;for(let x=0;x<q;x++){const i=s[x*3+0],u=s[x*3+1],l=s[x*3+2],F=t-i,k=d-u,h=e-l,n=F*F+k*k+h*h;n<a&&(a=n,o=i,c=u,y=l)}return[o,c,y]}function P(t){switch(t){case"jjn":return{denom:48,offsets:[{dx:1,dy:0,w:7},{dx:2,dy:0,w:5},{dx:-2,dy:1,w:3},{dx:-1,dy:1,w:5},{dx:0,dy:1,w:7},{dx:1,dy:1,w:5},{dx:2,dy:1,w:3},{dx:-2,dy:2,w:1},{dx:-1,dy:2,w:3},{dx:0,dy:2,w:5},{dx:1,dy:2,w:3},{dx:2,dy:2,w:1}]};case"stucki":return{denom:42,offsets:[{dx:1,dy:0,w:8},{dx:2,dy:0,w:4},{dx:-2,dy:1,w:2},{dx:-1,dy:1,w:4},{dx:0,dy:1,w:8},{dx:1,dy:1,w:4},{dx:2,dy:1,w:2},{dx:-2,dy:2,w:1},{dx:-1,dy:2,w:2},{dx:0,dy:2,w:4},{dx:1,dy:2,w:2},{dx:2,dy:2,w:1}]};case"atkinson":return{denom:8,offsets:[{dx:1,dy:0,w:1},{dx:2,dy:0,w:1},{dx:-1,dy:1,w:1},{dx:0,dy:1,w:1},{dx:1,dy:1,w:1},{dx:0,dy:2,w:1}]};case"burkes":return{denom:32,offsets:[{dx:1,dy:0,w:8},{dx:2,dy:0,w:4},{dx:-2,dy:1,w:2},{dx:-1,dy:1,w:4},{dx:0,dy:1,w:8},{dx:1,dy:1,w:4},{dx:2,dy:1,w:2}]};case"sierra-lite":return{denom:4,offsets:[{dx:1,dy:0,w:2},{dx:-1,dy:1,w:1},{dx:0,dy:1,w:1}]};case"sierra-2-4a":return{denom:16,offsets:[{dx:1,dy:0,w:4},{dx:2,dy:0,w:3},{dx:-2,dy:1,w:1},{dx:-1,dy:1,w:2},{dx:0,dy:1,w:3},{dx:1,dy:1,w:2},{dx:2,dy:1,w:1}]};case"sierra-3":return{denom:32,offsets:[{dx:1,dy:0,w:5},{dx:2,dy:0,w:3},{dx:-2,dy:1,w:2},{dx:-1,dy:1,w:4},{dx:0,dy:1,w:5},{dx:1,dy:1,w:4},{dx:2,dy:1,w:2},{dx:-2,dy:2,w:2},{dx:-1,dy:2,w:3},{dx:0,dy:2,w:2}]};case"stevenson-arce":return{denom:200,offsets:[{dx:2,dy:0,w:32},{dx:-3,dy:1,w:12},{dx:-1,dy:1,w:26},{dx:1,dy:1,w:30},{dx:3,dy:1,w:16},{dx:-2,dy:2,w:12},{dx:0,dy:2,w:26},{dx:2,dy:2,w:12},{dx:-3,dy:3,w:5},{dx:-1,dy:3,w:12},{dx:1,dy:3,w:12},{dx:3,dy:3,w:5}]};case"floyd-steinberg":default:return{denom:16,offsets:[{dx:1,dy:0,w:7},{dx:-1,dy:1,w:3},{dx:0,dy:1,w:5},{dx:1,dy:1,w:1}]}}}function T(t){const{width:d,height:e,data:s,serpentine:a,diffusionStrength:o,thresholdBias:c,pixelate:y,kernelName:q}=t,x=new Uint8ClampedArray(d*e*4),i=new Float32Array(d*e),u=new Float32Array(d*e),l=new Float32Array(d*e);for(let n=0;n<e;n++)for(let w=0;w<d;w++){const B=y>1?Math.floor(w/y)*y:w,A=((y>1?Math.floor(n/y)*y:n)*d+B)*4,m=s[A],r=s[A+1],g=s[A+2],[p,M,S]=K(m,r,g,t),b=n*d+w;i[b]=p,u[b]=M,l[b]=S}const F=t.palette,k=P(q),h=c*32;for(let n=0;n<e;n++){const w=!a||n%2===0,B=w?0:d-1,E=w?d:-1,A=w?1:-1;for(let m=B;m!=E;m+=A){const r=n*d+m;let g=i[r]+h,p=u[r]+h,M=l[r]+h;g=f(g),p=f(p),M=f(M);const[S,b,I]=N(g,p,M,F);x[r*4+0]=S,x[r*4+1]=b,x[r*4+2]=I,x[r*4+3]=255;const U=(g-S)*o,z=(p-b)*o,D=(M-I)*o;for(const j of k.offsets){const H=w?j.dx:-j.dx,J=j.dy,G=j.w/k.denom,R=m+H,v=n+J;if(R>=0&&R<d&&v>=0&&v<e){const C=v*d+R;i[C]+=U*G,u[C]+=z*G,l[C]+=D*G}}}}return x}self.onmessage=t=>{const d=t.data;if(d.type==="fs"){const e=T(d.params),s={type:"result",rgba:e,width:d.params.width,height:d.params.height};self.postMessage(s,[e.buffer])}}})();
